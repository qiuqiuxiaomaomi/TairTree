# TairTree
Tair分布式存储


![](https://i.imgur.com/LJOUEvd.png)


<pre>
Tair是淘宝的一个开源项目，它是一个分布式的key/value结构数据的解决方案。

作为一个分布式系统，Tair由一个中心控制节点（config server）和一些列的
服务节点（data server）组成。
     1）config server
        负责管理所有data server，并维护data server的状态信息；
        为了保证高可用,config server可通过heartbeat以一主一备形式提供服务。

     2）data server
        对外提供各种数据服务，并以心跳的形式将自身状况汇报给config server；
        所有的data server地位都是等价的。
</pre>

<pre>
Tair集群的基本概念
      
      configId:唯一标识一个tair集群，每个集群都有一个对应的configId，对应了集群
               的configserver地址和groupname，业务在初始化tair client的时候需要配置
               configId;

      namespace:又称area，是Tair中分配给应用的一个内存或者持久化存储区域，可以认为应用的
                数据存储在自己的namespace中，同一个集群(configId)中的namespace是唯一
                的。通过引入namespace，我们可以支持不同的应用在同集群中使用相同的key存放
                数据，也就是key相同，但内容不会冲突。一个namespace下如果存放相同的key，
                那么内容就会受到影响，在简单K/V形式下会被覆盖，rdb等待有数据结构的存储
                引擎内容会根据不同的接口发生不同的变化。

      quota配额：对应了每个namespace储存区的大小限制，超过配额后数据将面临最近最少使用的
                淘汰。持久化引擎（ldb）本身没有配额，ldb由于自带了mdb cache，所以也可以
                设置cache的配额，超过配额后，在内置的mdb内部进行淘汰。

      expireTime:数据的过期时间。当超过过期时间后，数据将对应用不可见，不同的存储引擎有
                 不同的策略清理掉过期的数据。
</pre>

![](https://i.imgur.com/TMHtlIM.png)

<pre>
存储引擎
      Tair存储引擎分为持久化存储引擎和非持久化存储引擎

      1）非持久化存储引擎
         可以看成是一个分布式缓存
      2）持久化存储引擎
         持久化的Tair将数据存放于磁盘，为了解决磁盘损坏导致数据丢失,Tair可以配置数据的备
         份数目。Tair自动将一份数据的不同备份存放到不同的主机上，当有主机发生异常，无法
         正常提供服务的时候，其余的备份会继续提供服务。

   Tair主要有下面三种存储引擎：
       1）mdb：定位于cache缓存，类似于memcache。支持K/V存取和prefix操作。
       2）rdb: 定位于cache缓存，采用了redis的内存存储结构，支持K/V,list, hash,set,
               sortedset等数据结构。
       3）ldb：定位于高性能存储，采用了levelDB作为引擎，并可选择内嵌mdb cache加速，这种
               情况下cache与持久化存储的数据一致性由Tair进行维护，支持K/V,prefix等数据
               结构，今后将支持list, hash, set, sortedset等Redis支持的数据结构。
</pre>

![](https://i.imgur.com/Ro7Q8Wq.png)

<pre>
Tair分布式策略：
      Tair的分布式采用的是一致性hash算法，对于所有的key，分到Q个桶中，桶是负载均衡和数据
   迁移的基本单位。config server根据一定的策略把每个桶指派到不同的data server上，因为数据
   按照key做hash算法，所以可以认为每个桶中的数据基本是平衡改的，保证了桶分布的均衡性，就
   保证了数据分布的均衡性。

   如果有多个备份，那么对照表将包含多列，比如备份是为3，则表有4列，后面的3列都是数据存储的节点。

   为了增强数据的安全性，Tair支持配置数据的备份数（COPY_COUNT）。比如你可以配置备份数为3，
   则每个bucket都会写在不同的3台机器上。当数据写入一个节点（通常我们称其为主节点）后，主
   节点会根据对照表自动将数据写入到其他备份节点，整个过程对用户是透明的。

   当有新节点加入或者节点不可用时，config server会根据当前可用节点，重新build一张对照表。
   数据节点同步到新的对照表中，会自动将在新表中不由自己负责的数据迁移到新的目标节点。迁移完
   成后，客户端可以从config server同步到新的对照表，完成扩容或者容灾过程，这个过程对用户
   是透明的，服务不中断。

   为了更进一步的提高数据的安全性，Tair的config server在build对照表的时候，可以配置考虑
   机房和机架信息。比如你配置备份数为3，集群的节点分布在两个不同的机房A和B，则Tair会确保每
   个解放至少有一份数据。当A机房包含两份数据时，Tair会确保这两份数据会分布在不同机架的节点
   上。这可以防止整个机房发生事故和某个机架发生故障的情况，这里提到的特性需要节点物理分布的
   支持，当前是通过可配置的IP掩码来区别不同机房和机架的节点。

   Tair提供了两种生成对照表的策略：
      1）负载均衡优先，config server会尽量的把桶均匀的分布到各个data server上，所谓尽量
         是指在不违背下面原则的条件下尽量负载均衡：
             每个桶必须有copy_count份数据；
             一个桶的各份数据不能在同一台主机上。
      2）位置安全优先，一般我们通过控制_pos_maks来使得不同的机房具有不同的位置信息，一个桶
         的各份数据不能都位于相同的一个位置
</pre>

<pre>
一致性和可靠性
      分布式系统中的可靠性和一致性是无法同时保证的，因为我们必须允许网络错误的发生，Tair采
   用复制技术来提高可靠性，并且为了提高效率做了一些优化。事实上在没有发生错误的时候，Tair
   提供的是一种强一致性，但是在data server发生故障的时候，客户有可能在一定时间窗口内读取
   不到最新的数据，甚至发生最新数据丢失的情况。
</pre>

<pre>
version
      Tair中的每个数据都包含版本号，版本号在每次更新后都会递增。这个特性可以帮助防止数据
   的并发更新导致的问题。

   如何获取当前key的version?
      get接口返回的是DataEntry对象，该对象中包含get到的数据的版本号，可以通过getVersion()接口获得该版本号。

      在put时，将该版本号作为put的参数即可，如果不考虑版本问题，则可设置version参数为0，
      系统将强行覆盖数据，即使版本不一致。

   Version改变的逻辑如下：

      1）如果put新数据且没有设置版本号，会自动将版本设置成1；
      2）如果put是更新老数据且没有版本号，或者put传来的参数版本与当前版本一致，版本号自增1；
      3）如果put是更新老数据且传来的参数版本与当前版本不一致，更新失败，返回VersionError；
      5）put时传入的version参数为0，则强制更新成功，版本号自增1。
</pre>